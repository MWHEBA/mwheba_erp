{% load static %}
{% load i18n %}
{% load custom_filters %}

{% comment %}
مكون جدول بيانات للعرض في صفحات القوائم مع دعم الترتيب والفلترة

الاستخدام:
{% include "components/data_table.html" with table_id="products-table" headers=headers data=products %}

المعلمات:
- table_id: معرف الجدول (اختياري، افتراضي "data-table")
- headers: قائمة برؤوس الأعمدة [{'key': 'name', 'label': 'الاسم', 'sortable': True, 'width': '10%', 'class': 'text-center'}, ...] 
- data: قائمة العناصر المعروضة
- empty_message: رسالة عندما لا توجد بيانات (اختياري، افتراضي "لا توجد بيانات للعرض")
- table_class: فئات CSS إضافية للجدول (اختياري)
- primary_key: اسم الحقل المستخدم كمفتاح أساسي (اختياري، افتراضي "id")
- action_buttons: قائمة بأزرار الإجراءات مثل [{'url': 'edit_url', 'icon': 'fa-edit', 'label': 'تعديل', 'class': 'action-edit'}]
- responsive: هل الجدول مستجيب (اختياري، افتراضي True)
- sortable: هل الجدول قابل للترتيب (اختياري، افتراضي True)
- current_order_by: الحقل الحالي للترتيب (اختياري، افتراضي "")
- current_order_dir: اتجاه الترتيب الحالي (اختياري، افتراضي "")
- row_class_callback: دالة لتحديد فئة الصفوف تبعاً لمحتواها (اختياري)
- show_currency: هل تظهر رمز العملة في القيم المالية (اختياري، افتراضي False)
- currency_symbol: رمز العملة (اختياري، افتراضي "ج.م")
- hover_effect: هل تظهر تأثير عند المرور على الصف (اختياري، افتراضي True)
- show_search: إظهار مربع البحث (اختياري، افتراضي True)
- show_length_menu: إظهار قائمة عدد العناصر (اختياري، افتراضي True)
- length_options: خيارات عدد العناصر [10, 25, 50, 100] (اختياري)
{% endcomment %}

{% if show_search|default:True or show_length_menu|default:True %}
<div class="table-controls mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        {% if show_length_menu|default:True %}
        <div class="table-length-control d-flex align-items-center">
            <span class="length-label me-2">{% trans "عرض" %}</span>
            <select class="form-select form-select-sm table-length" data-table="{{ table_id|default:'data-table' }}" aria-label="{% trans 'عدد العناصر' %}">
                {% for option in length_options|default:"10,25,50,100"|split:"," %}
                <option value="{{ option }}" {% if option == '25' %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
            <span class="length-label ms-2">{% trans "عنصر" %}</span>
        </div>
        {% endif %}
        
        {% if show_search|default:True %}
        <div class="table-search-control">
            <div class="input-group">
                <input type="text" class="form-control form-control-sm table-search" placeholder="{% trans 'بحث...' %}" aria-label="{% trans 'بحث' %}" data-table="{{ table_id|default:'data-table' }}">
                <span class="input-group-text search-icon">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div {% if responsive|default:True %}class="table-responsive"{% endif %}>
    <table id="{{ table_id|default:'data-table' }}" class="transaction-table {{ table_class }}" style="width: 100%">
        <thead>
            <tr>
                {% for header in headers %}
                    <th {% if header.width %}style="width: {{ header.width }};"{% endif %} class="{% if header.class %}{{ header.class }}{% endif %} col-{{ header.key }} text-center">
                        {% if sortable|default:True and header.sortable %}
                            <a href="?order_by={{ header.key }}{% if current_order_by == header.key and current_order_dir != 'desc' %}&order_dir=desc{% endif %}{% for param, value in request.GET.items %}{% if param != 'order_by' and param != 'order_dir' %}&{{ param }}={{ value }}{% endif %}{% endfor %}" class="d-flex align-items-center justify-content-center text-decoration-none">
                                <span>{{ header.label }}</span>
                                {% if current_order_by == header.key %}
                                    {% if current_order_dir == 'desc' %}
                                        <i class="fas fa-sort-down ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort-up ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                {% endif %}
                            </a>
                        {% else %}
                            <span class="d-block text-center">{{ header.label }}</span>
                        {% endif %}
                    </th>
                {% endfor %}
                {% if action_buttons %}
                    <th class="text-center col-actions">{% trans "إجراءات" %}</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% if data %}
                {% for item in data %}
                    <tr {% if row_class_callback %}class="{{ item|call:row_class_callback }}"{% endif %}>
                        {% for header in headers %}
                            {% with field_value=item|get_attr:header.key %}
                                <td class="{% if header.class %}{{ header.class }}{% endif %} col-{{ header.key }}">
                                    {% if header.template %}
                                        {% include header.template with value=field_value object=item %}
                                    {% elif header.format == 'date' %}
                                        <span class="transaction-date">{{ field_value|date:"Y-m-d" }}</span>
                                    {% elif header.format == 'datetime' %}
                                        <span class="transaction-date">{{ field_value|date:"Y-m-d H:i" }}</span>
                                    {% elif header.format == 'currency' %}
                                        <span class="transaction-amount {% if header.variant %}{{ header.variant }}{% endif %}" style="text-align: center; width: 100%; display: block;">
                                            {% if field_value == None or field_value == '' %}
                                                <strong style="text-align: center; display: block;"><span class="text-muted">-</span></strong>
                                            {% elif field_value == 0 %}
                                                {% if header.key == 'balance' %}
                                                    <strong style="text-align: center; display: block;"><span class="text-muted">-</span></strong>
                                                {% else %}
                                                    <strong style="text-align: center; display: block;"><span class="currency-symbol">{{ currency_symbol|default:'ج.م' }}</span> 0</strong>
                                                {% endif %}
                                            {% else %}
                                                <strong style="text-align: center; display: block;"><span class="currency-symbol">{{ currency_symbol|default:'ج.م' }}</span> {{ field_value|custom_number_format:header.decimals|default:2 }}</strong>
                                            {% endif %}
                                        </span>
                                    {% elif header.format == 'boolean' %}
                                        {% if header.key == 'is_active' %}
                                            {% if field_value %}
                                                <span class="badge bg-success">{% trans "نشط" %}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{% trans "غير نشط" %}</span>
                                            {% endif %}
                                        {% else %}
                                            {% if field_value %}
                                                <span class="badge bg-success">نعم</span>
                                            {% else %}
                                                <span class="badge bg-secondary">لا</span>
                                            {% endif %}
                                        {% endif %}
                                    {% elif header.format == 'image' %}
                                        {% if field_value %}
                                            <img src="{{ field_value.url }}" alt="صورة" class="img-thumbnail" style="max-width: 50px; height: auto;">
                                        {% else %}
                                            <i class="fas fa-image text-muted"></i>
                                        {% endif %}
                                    {% elif header.format == 'status' %}
                                        <div class="expense-status-cell">
                                            {% if header.key == 'is_active' %}
                                                {% if field_value %}
                                                    <span class="badge bg-success">{% trans "نشط" %}</span>
                                                {% elif field_value == False %}
                                                    <span class="badge bg-danger">{% trans "غير نشط" %}</span>
                                                {% else %}
                                                    <span class="badge bg-warning">{% trans "غير محدد" %} ({{ field_value|stringformat:'r' }})</span>
                                                {% endif %}
                                            
                                            <!-- معالجة حالة الدفع -->
                                            {% elif header.key == 'payment_status' %}
                                                {% if field_value == 'paid' %}
                                                    <span class="badge bg-success">{% trans "مدفوعة" %}</span>
                                                {% elif field_value == 'partially_paid' %}
                                                    <span class="badge bg-warning">{% trans "مدفوعة جزئياً" %}</span>
                                                {% elif field_value == 'unpaid' %}
                                                    <span class="badge bg-danger">{% trans "غير مدفوعة" %}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ field_value }}</span>
                                                {% endif %}
                                                
                                            <!-- معالجة طريقة الدفع -->
                                            {% elif header.key == 'payment_method' %}
                                                {% if field_value == 'cash' %}
                                                    <span class="badge payment-method cash">{% trans "نقدي" %}</span>
                                                {% elif field_value == 'credit' %}
                                                    <span class="badge payment-method credit">{% trans "آجل" %}</span>
                                                {% elif field_value == 'bank_transfer' %}
                                                    <span class="badge payment-method bank-transfer">{% trans "تحويل بنكي" %}</span>
                                                {% else %}
                                                    <span class="badge payment-method">{{ field_value }}</span>
                                                {% endif %}
                                                
                                            <!-- معالجة حالة الإرجاع -->
                                            {% elif header.key == 'return_status' %}
                                                {% if field_value == 'full' %}
                                                    <span class="badge bg-danger">{% trans "مرتجع كلي" %}</span>
                                                {% elif field_value == 'partial' %}
                                                    <span class="badge bg-warning">{% trans "مرتجع جزئي" %}</span>
                                                {% elif not field_value %}
                                                    <span class="text-muted">-</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ field_value }}</span>
                                                {% endif %}
                                                
                                            {% elif field_value == 'paid' %}
                                                <span class="badge bg-success">{% trans "مدفوع" %}</span>
                                            {% elif field_value == 'pending' %}
                                                <span class="badge bg-warning">{% trans "معلق" %}</span>
                                            {% elif field_value == 'received' %}
                                                <span class="badge bg-success">{% trans "مستلم" %}</span>
                                            {% elif field_value == 'cancelled' %}
                                                <span class="badge bg-danger">{% trans "ملغي" %}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ field_value }}</span>
                                            {% endif %}
                                        </div>
                                    {% elif header.format == 'reference' %}
                                        {% if field_value %}
                                            {% if header.variant == 'highlight-code' %}
                                                <div class="transaction-ref text-center">
                                                    {% if header.key == 'reference_number' or header.key == 'number' %}
                                                        {% if header.app == 'purchase' %}
                                                        <a href="{% url 'purchase:purchase_detail' item.id %}" class="text-decoration-none">
                                                        {% elif header.app == 'sale' %}
                                                        <a href="{% url 'sale:sale_detail' item.id %}" class="text-decoration-none">
                                                        {% else %}
                                                        <a href="#" class="text-decoration-none">
                                                        {% endif %}
                                                            <span class="badge invoice-number"><i class="fas fa-file-invoice me-1"></i> {{ field_value }}</span>
                                                        </a>
                                                    {% else %}
                                                        <span class="badge invoice-number"><i class="fas fa-file-invoice me-1"></i> {{ field_value }}</span>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <div class="transaction-ref text-center">{{ field_value }}</div>
                                            {% endif %}
                                        {% else %}
                                            <strong style="text-align: center; display: block;"><span class="text-muted">-</span></strong>
                                        {% endif %}
                                    {% elif header.format == 'icon_text' %}
                                        <div class="d-flex align-items-center">
                                            {% if header.icon_callback %}
                                                <div class="transaction-icon {{ item|call:header.icon_callback }}">
                                                    <i class="fas {{ item|call:header.icon_class_callback }}"></i>
                                                </div>
                                            {% endif %}
                                            <div {% if header.icon_callback %}class="transaction-type-text me-2"{% endif %}>
                                                {% if header.key == 'transaction_type' %}
                                                    {{ item|call:"get_transaction_type_display" }}
                                                {% else %}
                                                    {{ field_value }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        {% if header.ellipsis|default:False %}
                                            <div class="description">{{ field_value }}</div>
                                        {% else %}
                                            {{ field_value }}
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endwith %}
                        {% endfor %}
                        
                        {% if action_buttons %}
                            <td class="text-center col-actions">
                                <div class="d-flex justify-content-center">
                                    {% for button in action_buttons %}
                                        {% if ':' in button.url %}
                                            {% with url_name=button.url %}
                                                <a href="{% url url_name item.id %}" 
                                                   class="action-button {{ button.class|default:'action-view' }}" 
                                                   title="{{ button.label }}"
                                                   {% if button.data_attrs %}{{ button.data_attrs|safe }}{% endif %}>
                                                    <i class="fas {{ button.icon }}"></i>
                                                </a>
                                            {% endwith %}
                                        {% else %}
                                            <a href="{{ button.url|replace_id:item|get_attr:primary_key|default:'id' }}" 
                                               class="action-button {{ button.class|default:'action-view' }}" 
                                               title="{{ button.label }}"
                                               {% if button.data_attrs %}{{ button.data_attrs|safe }}{% endif %}>
                                                <i class="fas {{ button.icon }}"></i>
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{% if action_buttons %}{{ headers|length|add:1 }}{% else %}{{ headers|length }}{% endif %}" class="text-center py-5">
                        {% include "partials/empty_state.html" with message=empty_message|default:"لا توجد بيانات للعرض" icon="fa-table" container_class="empty-state-sm" %}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if data and show_info|default:True %}
<div class="table-info-section mt-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div class="table-info-text">
            {% if data.has_other_pages %}
                <span class="pagination-info">عرض {{ data.start_index }} إلى {{ data.end_index }} من إجمالي {{ data.paginator.count }} عنصر</span>
            {% else %}
                <span class="pagination-info">عرض {{ data|length }} عنصر</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %} 