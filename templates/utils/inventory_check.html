{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load utils_extras %}

{% block title %}{{ title }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="{{ page_icon }}"></i> {{ page_title }}
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="printReport('inventory-check-report')">
                            <i class="fas fa-print"></i> {% trans "طباعة التقرير" %}
                        </button>
                    </div>
                </div>
                <div class="card-body" id="inventory-check-report">
                    <h4 class="mb-4">{% trans "تقرير فحص المخزون" %}</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-warning text-dark">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {% trans "منتجات أقل من الحد الأدنى" %}
                                    </h5>
                                    <h3>{{ low_stock_items.count }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-times-circle"></i>
                                        {% trans "منتجات نفذت من المخزون" %}
                                    </h5>
                                    <h3>{{ out_of_stock_items.count }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if low_stock_items %}
                    <h5 class="mt-4 mb-3">{% trans "المنتجات أقل من الحد الأدنى" %}</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th>{% trans "المنتج" %}</th>
                                    <th>{% trans "الكود" %}</th>
                                    <th>{% trans "المخزن" %}</th>
                                    <th>{% trans "الكمية الحالية" %}</th>
                                    <th>{% trans "الحد الأدنى" %}</th>
                                    <th>{% trans "النقص" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in low_stock_items %}
                                <tr>
                                    <td>{{ stock.product.name }}</td>
                                    <td>{{ stock.product.sku }}</td>
                                    <td>{{ stock.warehouse.name }}</td>
                                    <td>{{ stock.quantity }}</td>
                                    <td>{{ stock.product.min_stock }}</td>
                                    <td class="text-danger">{{ stock.product.min_stock|sub:stock.quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-4">
                        <i class="fas fa-check-circle"></i> {% trans "جميع المنتجات في مستوى مخزون جيد" %}
                    </div>
                    {% endif %}
                    
                    {% if out_of_stock_items %}
                    <h5 class="mt-4 mb-3">{% trans "المنتجات التي نفذت من المخزون" %}</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th>{% trans "المنتج" %}</th>
                                    <th>{% trans "الكود" %}</th>
                                    <th>{% trans "المخزن" %}</th>
                                    <th>{% trans "الكمية الحالية" %}</th>
                                    <th>{% trans "الحد الأدنى" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in out_of_stock_items %}
                                <tr>
                                    <td>{{ stock.product.name }}</td>
                                    <td>{{ stock.product.sku }}</td>
                                    <td>{{ stock.warehouse.name }}</td>
                                    <td class="text-danger">{{ stock.quantity }}</td>
                                    <td>{{ stock.product.min_stock }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <small class="text-muted">{% trans "تم التحقق في" %} {% now "Y-m-d H:i" %}</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    function printReport(elementId) {
        const printContents = document.getElementById(elementId).innerHTML;
        const originalContents = document.body.innerHTML;
        
        document.body.innerHTML = `
            <div class="container mt-4">
                <h3 class="text-center mb-4">{% trans "تقرير فحص المخزون" %}</h3>
                ${printContents}
            </div>
        `;
        
        window.print();
        document.body.innerHTML = originalContents;
    }
</script>
{% endblock %} 