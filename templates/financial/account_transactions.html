{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<link rel="stylesheet" href="{% static 'css/cards.css' %}">
<style>
  .transaction-row {
    transition: all 0.2s ease;
  }
  .transaction-row:hover {
    background-color: rgba(0,0,0,0.03);
  }
  .transaction-type {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }
  .transaction-type.income {
    background-color: #28a745;
  }
  .transaction-type.expense {
    background-color: #dc3545;
  }
  .transaction-type.transfer {
    background-color: #007bff;
  }
  .transaction-amount {
    font-weight: bold;
  }
  .transaction-amount.positive {
    color: #28a745;
  }
  .transaction-amount.negative {
    color: #dc3545;
  }
  .filter-section {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- عنوان الصفحة (مضمن مباشرة) -->
  <div class="mb-4">
    <!-- Breadcrumbs -->
    <div class="mb-2">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          {% for item in breadcrumb_items %}
            {% if item.active %}
              <li class="breadcrumb-item active" aria-current="page">
                {% if item.icon %}<i class="{{ item.icon }} me-1"></i>{% endif %}
                {{ item.title }}
              </li>
            {% else %}
              <li class="breadcrumb-item">
                <a href="{{ item.url }}">
                  {% if item.icon %}<i class="{{ item.icon }} me-1"></i>{% endif %}
                  {{ item.title }}
                </a>
              </li>
            {% endif %}
          {% endfor %}
        </ol>
      </nav>
    </div>
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
      <div class="d-flex align-items-center">
        <div class="me-3">
          {% if account.account_type == 'cash' %}
            <i class="fas fa-money-bill-wave fa-2x text-success"></i>
          {% elif account.account_type == 'bank' %}
            <i class="fas fa-university fa-2x text-primary"></i>
          {% elif account.account_type == 'wallet' %}
            <i class="fas fa-wallet fa-2x text-purple"></i>
          {% else %}
            <i class="fas fa-landmark fa-2x text-secondary"></i>
          {% endif %}
        </div>
        <div>
          <h1 class="h3 mb-1">{{ page_title }}</h1>
          <p class="text-muted mb-0">
            {% trans "الرصيد الحالي:" %} {{ account.balance }} {% trans "جنيه" %} | 
            {% if account.account_type == 'cash' %}
              {% trans "حساب نقدي" %}
            {% elif account.account_type == 'bank' %}
              {% trans "حساب بنكي" %}
            {% elif account.account_type == 'wallet' %}
              {% trans "محفظة إلكترونية" %}
            {% else %}
              {% trans "حساب آخر" %}
            {% endif %}
          </p>
        </div>
      </div>
      <div>
        <a href="{% url 'financial:transaction_create' %}" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>{% trans "إضافة معاملة جديدة" %}
        </a>
        <a href="{% url 'financial:account_detail' account.id %}" class="btn btn-outline-secondary ms-2">
          <i class="fas fa-info-circle me-2"></i>{% trans "تفاصيل الحساب" %}
        </a>
      </div>
    </div>
  </div>

  <!-- قائمة المعاملات -->
  <div class="section-container">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>{% trans "قائمة معاملات الحساب" %}</h5>
        <div class="actions-container">
          <a href="{% url 'financial:transaction_create' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i>{% trans "إضافة معاملة" %}
          </a>
        </div>
      </div>
      <div class="card-body">
        <!-- استخدام قالب الجدول الموحد -->
        {% with table_id="account-transactions-table" %}
          {% with headers=transaction_headers %}
            {% with data=transactions %}
              {% with empty_message="لا توجد معاملات مالية للعرض لهذا الحساب" %}
                {% with table_class="hover" %}
                  {% with action_buttons=transaction_actions %}
                    {% with primary_key="id" %}
                      {% with show_currency=True currency_symbol="ج.م" %}
                        {% with show_search=True show_length_menu=True length_options="10,25,50,100" %}
                          {% include "components/data_table.html" %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% endwith %}
              {% endwith %}
            {% endwith %}
          {% endwith %}
        {% endwith %}
        
        <!-- إضافة زر تصدير البيانات -->
        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-sm btn-outline-secondary btn-export-table me-2" data-table="account-transactions-table" data-filename="account_transactions.csv">
            <i class="fas fa-file-csv me-1"></i>{% trans "تصدير CSV" %}
          </button>
          <button type="button" class="btn btn-sm btn-outline-success btn-export-excel" data-table="account-transactions-table" data-filename="account_transactions.xlsx">
            <i class="fas fa-file-excel me-1"></i>{% trans "تصدير Excel" %}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- مكتبة SheetJS لتصدير البيانات إلى Excel بدعم كامل للغة العربية -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- استخدام مكتبة DataTables من ملف datatables.min.js الموجود -->
<script src="{% static 'js/global-table.js' %}"></script>
<script>
  $(document).ready(function() {
    // تهيئة جدول المعاملات
    initGlobalTable('account-transactions-table', {
      order: [1, 'desc'],  // ترتيب حسب التاريخ تنازلياً
      columnDefs: [
        { targets: 'col-actions', orderable: false, width: '100px' },
        { targets: 'col-transaction_type', orderable: false },
        { targets: 'col-description', width: '25%' },
        { targets: 'col-date', width: '10%' }
      ],
      autoWidth: true,
      responsive: true
    });
    
    // تنسيق حقول التاريخ
    $('input[type="date"]').addClass('form-control');
    
    // ضبط حجم الجدول عند تحميل الصفحة وعند تغيير حجم النافذة
    function adjustTableSize() {
      var containerWidth = $('.dataTables_wrapper').parent().width();
      $('.dataTables_wrapper').css('width', containerWidth + 'px');
    }
    
    adjustTableSize();
    $(window).resize(function() {
      adjustTableSize();
    });
  });
</script>
{% endblock %} 