{% load static %}

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">{{ form_title|default:"حساب جديد" }}</h6>
    </div>
    <div class="card-body">
        <form method="post" id="accountForm">
            {% csrf_token %}
            
            <!-- رسالة الخطأ -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <strong>هناك أخطاء في النموذج:</strong>
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- معلومات الحساب الأساسية -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">اسم الحساب <span class="text-danger">*</span></label>
                        {{ form.name }}
                        <div class="invalid-feedback">{{ form.name.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.code.id_for_label }}">كود الحساب</label>
                        {{ form.code }}
                        <div class="invalid-feedback">{{ form.code.errors }}</div>
                        <small class="form-text text-muted">مثال: 1001 لحسابات الأصول</small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.type.id_for_label }}">نوع الحساب <span class="text-danger">*</span></label>
                        {{ form.type }}
                        <div class="invalid-feedback">{{ form.type.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.account_type.id_for_label }}">تصنيف الحساب <span class="text-danger">*</span></label>
                        {{ form.account_type }}
                        <div class="invalid-feedback">{{ form.account_type.errors }}</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.parent.id_for_label }}">الحساب الرئيسي</label>
                        {{ form.parent }}
                        <div class="invalid-feedback">{{ form.parent.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.initial_balance.id_for_label }}">الرصيد الافتتاحي</label>
                        {{ form.initial_balance }}
                        <div class="invalid-feedback">{{ form.initial_balance.errors }}</div>
                    </div>
                </div>
            </div>
            
            <!-- معلومات إضافية للحسابات البنكية -->
            <div class="card mb-4 border-left-info" id="bankDetails" style="display: none;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">تفاصيل الحساب البنكي</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.bank_name.id_for_label }}">اسم البنك</label>
                                {{ form.bank_name }}
                                <div class="invalid-feedback">{{ form.bank_name.errors }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.account_number.id_for_label }}">رقم الحساب</label>
                                {{ form.account_number }}
                                <div class="invalid-feedback">{{ form.account_number.errors }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.branch.id_for_label }}">الفرع</label>
                                {{ form.branch }}
                                <div class="invalid-feedback">{{ form.branch.errors }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.iban.id_for_label }}">رقم الآيبان</label>
                                {{ form.iban }}
                                <div class="invalid-feedback">{{ form.iban.errors }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- الوصف والملاحظات -->
            <div class="form-group">
                <label for="{{ form.description.id_for_label }}">الوصف</label>
                {{ form.description }}
                <div class="invalid-feedback">{{ form.description.errors }}</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form.is_active }}
                            <label class="custom-control-label" for="{{ form.is_active.id_for_label }}">حساب نشط</label>
                        </div>
                        <div class="invalid-feedback">{{ form.is_active.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            {{ form.is_bank_reconciliation }}
                            <label class="custom-control-label" for="{{ form.is_bank_reconciliation.id_for_label }}">يخضع للتسوية البنكية</label>
                        </div>
                        <div class="invalid-feedback">{{ form.is_bank_reconciliation.errors }}</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group text-center">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <a href="{% url 'financial:account_list' %}" class="btn btn-secondary px-4">
                    <i class="fas fa-times"></i> إلغاء
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {
        // تنسيق الحقول
        $('.form-control').addClass('form-control-sm');
        
        // التحقق من نوع الحساب لعرض التفاصيل البنكية
        $('#{{ form.type.id_for_label }}').change(function() {
            const accountType = $(this).val();
            
            // إظهار/إخفاء تفاصيل الحساب البنكي حسب النوع
            if (accountType === 'bank') {
                $('#bankDetails').slideDown();
            } else {
                $('#bankDetails').slideUp();
            }
        });
        
        // تغيير لون الحساب حسب نوع التصنيف المحاسبي
        $('#{{ form.account_type.id_for_label }}').change(function() {
            const accountClass = $(this).val();
            
            // التعامل مع تغيير اللون حسب تصنيف الحساب
            const cardHeader = $('.card-header').first();
            
            // إزالة جميع الألوان السابقة
            cardHeader.removeClass('border-left-primary border-left-success border-left-danger border-left-warning border-left-info');
            
            // إضافة اللون المناسب حسب النوع
            if (accountClass === 'asset') {
                cardHeader.addClass('border-left-primary');
            } else if (accountClass === 'liability') {
                cardHeader.addClass('border-left-danger');
            } else if (accountClass === 'equity') {
                cardHeader.addClass('border-left-success');
            } else if (accountClass === 'income') {
                cardHeader.addClass('border-left-info');
            } else if (accountClass === 'expense') {
                cardHeader.addClass('border-left-warning');
            }
        });
        
        // تنفيذ التغيير الأول لتحديد الحالة الأولية
        $('#{{ form.type.id_for_label }}').trigger('change');
        $('#{{ form.account_type.id_for_label }}').trigger('change');
    });
</script> 