{% load static %}

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">{{ form_title|default:"مطابقة حساب بنكي جديدة" }}</h6>
    </div>
    <div class="card-body">
        <form method="post" id="bankReconciliationForm">
            {% csrf_token %}
            
            <!-- رسالة الخطأ -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <strong>هناك أخطاء في النموذج:</strong>
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- معلومات المطابقة الأساسية -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.account.id_for_label }}">الحساب البنكي <span class="text-danger">*</span></label>
                        {{ form.account }}
                        <div class="invalid-feedback">{{ form.account.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.statement_date.id_for_label }}">تاريخ كشف الحساب <span class="text-danger">*</span></label>
                        {{ form.statement_date }}
                        <div class="invalid-feedback">{{ form.statement_date.errors }}</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.statement_balance.id_for_label }}">رصيد كشف الحساب <span class="text-danger">*</span></label>
                        {{ form.statement_balance }}
                        <div class="invalid-feedback">{{ form.statement_balance.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.system_balance.id_for_label }}">رصيد النظام <span class="text-danger">*</span></label>
                        {{ form.system_balance }}
                        <div class="invalid-feedback">{{ form.system_balance.errors }}</div>
                        <small class="form-text text-muted" id="system_balance_note">سيتم احتساب هذا القيمة تلقائياً عند اختيار الحساب</small>
                    </div>
                </div>
            </div>
            
            <!-- تفاصيل المطابقة -->
            <div class="card mb-4 border-left-info">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">تفاصيل المطابقة</h6>
                </div>
                <div class="card-body">
                    <!-- المعاملات المعلقة في النظام ولم تظهر في كشف الحساب -->
                    <h6 class="text-primary">المعاملات المعلقة في النظام ولم تظهر في كشف الحساب</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.outstanding_deposits.id_for_label }}">إيداعات معلقة</label>
                                {{ form.outstanding_deposits }}
                                <div class="invalid-feedback">{{ form.outstanding_deposits.errors }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.outstanding_payments.id_for_label }}">مدفوعات معلقة</label>
                                {{ form.outstanding_payments }}
                                <div class="invalid-feedback">{{ form.outstanding_payments.errors }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- بنود في كشف الحساب ولم تسجل في النظام -->
                    <h6 class="text-primary">بنود ظهرت في كشف الحساب ولم تسجل في النظام</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.unrecorded_deposits.id_for_label }}">إيداعات غير مسجلة</label>
                                {{ form.unrecorded_deposits }}
                                <div class="invalid-feedback">{{ form.unrecorded_deposits.errors }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.unrecorded_payments.id_for_label }}">مدفوعات غير مسجلة</label>
                                {{ form.unrecorded_payments }}
                                <div class="invalid-feedback">{{ form.unrecorded_payments.errors }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- نتيجة المطابقة -->
            <div class="card mb-4 border-left-warning">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">نتيجة المطابقة</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.difference.id_for_label }}">الفرق</label>
                                {{ form.difference }}
                                <div class="invalid-feedback">{{ form.difference.errors }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.status.id_for_label }}">حالة المطابقة</label>
                                {{ form.status }}
                                <div class="invalid-feedback">{{ form.status.errors }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.notes.id_for_label }}">ملاحظات</label>
                        {{ form.notes }}
                        <div class="invalid-feedback">{{ form.notes.errors }}</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group text-center">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <a href="{% url 'financial:bank_reconciliation_list' %}" class="btn btn-secondary px-4">
                    <i class="fas fa-times"></i> إلغاء
                </a>
                <button type="button" id="calculateBtn" class="btn btn-info px-4">
                    <i class="fas fa-calculator"></i> حساب الفرق
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {
        // تنسيق الحقول
        $('.form-control').addClass('form-control-sm');
        
        // تنسيق حقول التاريخ
        $('input[type="date"]').attr('placeholder', 'YYYY-MM-DD');
        
        // تعطيل حقل رصيد النظام والفرق
        $('#{{ form.system_balance.id_for_label }}').prop('readonly', true);
        $('#{{ form.difference.id_for_label }}').prop('readonly', true);
        
        // عند تغيير الحساب، استرجاع رصيده الحالي من النظام
        $('#{{ form.account.id_for_label }}').change(function() {
            const accountId = $(this).val();
            if (accountId) {
                // لو في وضع التنفيذ الحقيقي، يمكن استخدام AJAX لاسترجاع رصيد الحساب
                // للتبسيط هنا، فقط سيتم عرض رسالة أن الرصيد سيتم استرجاعه تلقائياً
                $('#system_balance_note').text('جاري استرجاع رصيد الحساب...');
                
                // محاكاة استرجاع الرصيد - في التطبيق الحقيقي سيتم استبدال هذا بـ AJAX
                $.ajax({
                    url: '/financial/api/account/' + accountId + '/balance/',
                    type: 'GET',
                    success: function(data) {
                        $('#{{ form.system_balance.id_for_label }}').val(data.balance);
                        $('#system_balance_note').text('تم استرجاع رصيد الحساب');
                        calculateDifference();
                    },
                    error: function() {
                        $('#system_balance_note').text('فشل في استرجاع الرصيد، يرجى إدخال القيمة يدوياً');
                        $('#{{ form.system_balance.id_for_label }}').prop('readonly', false);
                    }
                });
            } else {
                $('#{{ form.system_balance.id_for_label }}').val('');
                $('#system_balance_note').text('سيتم احتساب هذا القيمة تلقائياً عند اختيار الحساب');
            }
        });
        
        // حساب الفرق بين الأرصدة والمعاملات المعلقة
        function calculateDifference() {
            const statementBalance = parseFloat($('#{{ form.statement_balance.id_for_label }}').val()) || 0;
            const systemBalance = parseFloat($('#{{ form.system_balance.id_for_label }}').val()) || 0;
            
            const outstandingDeposits = parseFloat($('#{{ form.outstanding_deposits.id_for_label }}').val()) || 0;
            const outstandingPayments = parseFloat($('#{{ form.outstanding_payments.id_for_label }}').val()) || 0;
            const unrecordedDeposits = parseFloat($('#{{ form.unrecorded_deposits.id_for_label }}').val()) || 0;
            const unrecordedPayments = parseFloat($('#{{ form.unrecorded_payments.id_for_label }}').val()) || 0;
            
            // حساب الفرق: رصيد البنك - (رصيد النظام - مدفوعات معلقة + إيداعات معلقة + مدفوعات غير مسجلة - إيداعات غير مسجلة)
            const adjustedSystemBalance = systemBalance - outstandingPayments + outstandingDeposits + unrecordedPayments - unrecordedDeposits;
            const difference = statementBalance - adjustedSystemBalance;
            
            $('#{{ form.difference.id_for_label }}').val(difference.toFixed(2));
            
            // تحديد حالة المطابقة
            if (Math.abs(difference) < 0.01) {
                $('#{{ form.status.id_for_label }}').val('reconciled');
            } else {
                $('#{{ form.status.id_for_label }}').val('unreconciled');
            }
        }
        
        // ربط وظيفة حساب الفرق بزر الحساب وبتغيير أي من الحقول ذات الصلة
        $('#calculateBtn').click(function(e) {
            e.preventDefault();
            calculateDifference();
        });
        
        $('#{{ form.statement_balance.id_for_label }}, #{{ form.outstanding_deposits.id_for_label }}, #{{ form.outstanding_payments.id_for_label }}, #{{ form.unrecorded_deposits.id_for_label }}, #{{ form.unrecorded_payments.id_for_label }}').change(function() {
            calculateDifference();
        });
        
        // تشغيل التغيير الأول لحساب الفرق إذا كانت القيم موجودة
        if ($('#{{ form.statement_balance.id_for_label }}').val() && $('#{{ form.system_balance.id_for_label }}').val()) {
            calculateDifference();
        }
    });
</script> 